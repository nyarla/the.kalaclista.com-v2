{{ $feed := dict }}
{{ $feed  = merge (dict "version" "https://jsonfeed.org/version/1") $feed }}
{{ $feed  = merge (dict "title" .Site.Title) $feed }}
{{ $feed  = merge (dict "description" (replace .Site.Params.descrption "<br>" "")) $feed }}
{{ $feed  = merge (dict "home_page_url" (absURL (printf "/%s/" .Site.Params.website))) $feed }}
{{ $feed  = merge (dict "feed_url" (absURL (printf "/%s/jsonfeed.json" .Site.Params.website))) $feed }}
{{ $feed  = merge (dict "icon" (absURL "/apple-touch-icon.png")) $feed }}
{{ $feed  = merge (dict "author" (dict "name" "OKAMURA Naoki" "url" "https://the.kalaclista.com/nyarla/" "avatar" "https://the.kalaclista.com/assets/avatar.svg")) $feed }}
{{ $items := slice }}

{{ if ne .Site.Params.website "home" }}

{{ range $page := first 10 .Site.RegularPages.ByDate.Reverse }}
{{ $entry := dict }}
{{ if eq $.Site.Params.website "bookmarks" }}
{{ $entry = merge (dict "id" (replaceRE "(\\d{6})/$" "#$1" $page.Permalink)) $entry }}
{{ $entry = merge (dict "url" (replaceRE "(\\d{6})/$" "#$1" $page.Permalink)) $entry }}
{{ else }}
{{ $entry = merge (dict "id" $page.Permalink) $entry }}
{{ $entry = merge (dict "url"  $page.Permalink) $entry }}
{{ end }}
{{ $entry = merge (dict "title" $page.Title) $entry }}
{{ $entry = merge (dict "content_html" (partial "functions/markup.html.html" $page.Content)) $entry }}
{{ $entry = merge (dict "date" $page.Date) $entry }}
{{ $entry = merge (dict "tags" $page.Params.tags) $entry }}
{{ $entry = merge (dict "external_link" $page.Params.link) $entry }}
{{ $items = $items | append $entry }}
{{ end }}

{{ else }}

{{ range $website := slice "posts" "echos" "notes" "bookmarks" }}
{{ $items = $items | append (index $.Site.Data.feed $website).items }}
{{ end }}

{{ end }}

{{ $feed = merge (dict "items" (sort $items "date" "desc")) $feed }}
{{ $feed | jsonify }}
