{{ $sitemap := slice }}
{{ $archives := dict }}
{{ $entries := slice }}

{{ $pages := .Site.Pages.ByDate.Reverse }}
{{ $before := (index $pages 0).Date }}

{{ range $page := $pages }}

{{ $permalink := $page.Permalink }}
{{ if eq $.Site.Params.website "bookmark" }}
{{ $permalink = replaceRE "(\\d)/$" "#$1" $permalink }}
{{ end }}

{{ $entry := dict "permalink" $permalink  }}

{{ if $page.IsPage }}
{{ $title := $page.Title }}
{{ $content := (partial "functions/content.html.html" $page.Content | unmarshal) }}
{{ $entry = merge (dict "title" $title "summary" $content.summary "content" $content.content "date" $page.Date) $entry }}

{{ if ne ($before.Format "2006-01") ($page.Date.Format "2006-01") }}
{{ $date := $before.Format "2006-01" }}
{{ $archives = merge (dict $date $entries) $archives }}
{{ $entries = slice }}
{{ $before = $page.Date }}
{{ else }}
{{ $entries = $entries | append $entry }}
{{ end }}

{{ else }}
{{ $entry = merge (dict "date" now) $entry }}
{{ end }}
{{ $sitemap = $sitemap | append $entry }}
{{ end }}
{{ dict "sitemap" $sitemap "archives" $archives | jsonify }}
