<!doctype html>
<html lang="ja">
  <head prefix="og: http://ogp.me/ns# website: http://ogp.me/ns/website#">
    {{ partial "shared/meta.html.html" . }}
    {{ partial "bookmarks/meta.html.html" . }}
  </head>
  <body>
    {{ partial "shared/header.html.html" . }}

    {{ define "bookmark" }}
    <article class="bookmark" data-edit-protocol="kalaclista:bookmarks/{{ .File.Path }}" data-edit-label="{{ .Title }}">
      <h1 id="{{ .Date.Format "150405" }}">
        <a href="{{ .Params.link }}">{{ .Title }}</a>
      </h1>
      <nav>
        {{ range $tag := sort (default slice .Params.tags) }}
        <a href="{{ absURL (printf "/bookmarks/tags/%s/" $tag) }}">{{ $tag }}</a>
        {{ end }}
      </nav>
      <section class="content">
        {{ partial "functions/markup.html.html" .Content }}
      </section>
    </article>
    {{ end }}

    {{ define "date" }}
    <h1 class="date">
      <a href="{{ absURL (printf "/bookmarks/%s/" (.Date.Format "2006/01/02")) }}">
        <time datetime="{{ .Date.Format "2006-01-02" }}">
          {{ .Date.Format "2006年1月2日" }}
        </time>
      </a>
    </h1>
    {{ end }}

    {{ if .Page.IsHome }}
      {{ $pager := .Paginate .Site.RegularPages.ByDate.Reverse }}
      {{ $pages := $pager.Pages }}

      {{ $before := (index $pages 0).Date }}
      <main id="bookmarks">
        {{ range $idx, $page := $pages }}
          {{ $displayDate := (or (eq $idx 0) (ne ($before.Format "2006-01-02") ($page.Date.Format "2006-01-02"))) }}

          {{ if $displayDate }}
            {{ block "date" $page }}
            {{ end }}
          {{ end }}

          {{ block "bookmark" $page }}
          {{ end }}

          {{ $before = $page.Date }}
        {{ end }}
        <nav class="pagination">
          {{ if $pager.HasPrev }}
          <a href="{{ absURL (printf "/bookmarks/pages/%d/" $pager.Prev.PageNumber) }}">前</a>
          {{ end }}

          {{ if $pager.HasNext }}
          <a href="{{ absURL (printf "/bookmarks/pages/%d/"  $pager.Next.PageNumber) }}">次</a>
          {{ end }}
        </nav>
      </main>
    {{ else }}
      {{ $pages := slice }} 

      {{ if eq .Page.Section "tags" }}
        {{ $pages = .Pages.ByDate.Reverse }}
      {{ else }}
        {{ $date := partial "functions/parsedate.html.html" .Page | unmarshal }}

        {{ if (and (default false $date.hasDay) (default false $date.hasMonth)) }}
          {{ $pages = where .Pages.ByDate.Reverse "IsPage" "==" true }}
        {{ else if (default false $date.hasMonth) }}
          {{ range $day := .Pages.ByDate.Reverse }}
            {{ $pages = $pages | append ($day.GetPage ($day.Date.Format "/2006/01/02")).Pages.ByDate.Reverse }}
          {{ end }}
        {{ else }}
          {{ range $month := .Pages.ByDate.Reverse }}
            {{ range $day := ($month.GetPage (replaceRE "(\\d{4})/(\\d{2})/" "/$1/$2" $month.File.Dir)).Pages.ByDate.Reverse }}
              {{ $pages = $pages | append ($day.GetPage ($day.Date.Format "/2006/01/02")).Pages.ByDate.Reverse }}
            {{ end }}
          {{ end }}
        {{ end }}
      {{ end }}

      {{ $count := 0 }}
      {{ $displayed := 0 }}
      {{ $before := (index $pages 0).Date }}
      <main id="bookmarks">
        {{ range $idx, $page := $pages }}
          {{ $displayDate := (or (eq $idx 0) (ne ($before.Format "2006-01-02") ($page.Date.Format "2006-01-02"))) }}

          {{ if $displayDate }}

          {{ if and (lt $displayed 3) (gt $count 7) }}
            {{ partial "shared/adsense.html.html" $.Site.Params.adsense.top }}
            {{ $displayed = add $displayed 1 }}
            {{ $count = 0 }}
          {{ end }}

          {{ block "date" $page }}
            {{ end }}
          {{ end }}

          {{ block "bookmark" $page }}
          {{ end }}
    
          {{ $before = $page.Date }}
          {{ $count = add $count 1 }}
        {{ end }}
        </main>
    {{ end }}

    {{ partial "shared/adsense.html.html" .Site.Params.adsense.bottom }}
    {{ partial "shared/footer.html.html" . }}
  </body>
</html>
