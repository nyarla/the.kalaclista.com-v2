<!doctype html>
<html lang="ja">
  <head prefix="og: http://ogp.me/ns# website: http://ogp.me/ns/website#">
    {{ partial "shared/meta.html.html" . }}
    {{ partial "echos/meta.html.html" . }}
  </head>
  <body>
    {{ partial "shared/header.html.html" . }}

    {{ define "echo" }}
    <article class="echo post" data-edit-protocol="kalaclista:echos/{{ .File.Path }}" data-edit-label="{{ .Title }}">
      <p class="date">
        <a href="{{ absURL (.Date.Format "/echos/2006/01/02/") }}">
            <time datetime="{{ .Date.Format "2006-01-02" }}">{{ .Date.Format "2006年1月2日" }}</time>
        </a>
      </p>
      <h1><a href="{{ .Permalink }}">{{ .Title }}</a></h1>
      <section class="content">
        {{ partial "functions/markup.html.html" .Content }}
      </section>

      <p class="postedat">
        <a href="https://the.kalaclista.com/nyarla/" class="hexagon">
          <img src="{{ absURL "/assets/avatar.svg"}}" width="24" height="24" alt="nyarla">
        </a>
        が大体<time datetime="2006-01-02">{{ .Date.Format "2006年1月2日" }}ぐらいに投稿</time></p>

      <p class="comment"><a href="https://scrapbox.io/kalaclista/{{ .Title }}">Scrapbox でコメントや意見を書く</a></p>
    </article>
    {{ end }}

    {{ if .Page.IsHome }}
      {{ $pager := .Paginate .Site.RegularPages.ByDate.Reverse }}
      {{ $pages := $pager.Pages }}

      {{ $count := 0 }}
      {{ $displayed := 0 }}

      <main id="echos">
        {{ range $idx, $page := $pages }}
          {{ block "echo" $page }}
          {{ end }}

          {{ if and (ne $count 0) (lt $displayed 2) (eq (mod $count 5) 0) }}
            {{ partial "shared/adsense.html.html" $.Site.Params.adsense.top }}
            {{ $displayed = add $displayed 1 }}
          {{ end }}

          {{ $count = add $count 1 }}
        {{ end }}
        
        <nav class="pagination">
          {{ if $pager.HasPrev }}
          <a href="{{ absURL (printf "/echos/pages/%d/" $pager.Prev.PageNumber) }}">前</a>
          {{ end }}

          {{ if $pager.HasNext }}
          <a href="{{ absURL (printf "/echos/pages/%d/"  $pager.Next.PageNumber) }}">次</a>
          {{ end }}
        </nav>
      </main>
    {{ else }}
      {{ $pages := slice }} 

      {{ if eq .Page.Section "tags" }}
        {{ $pages = .Pages.ByDate.Reverse }}
      {{ else }}
        {{ $date := partial "functions/parsedate.html.html" .Page | unmarshal }}

        {{ if (and (default false $date.hasDay) (default false $date.hasMonth)) }}
          {{ $pages = where .Pages.ByDate.Reverse "IsPage" "==" true }}
        {{ else if (default false $date.hasMonth) }}
          {{ range $day := .Pages.ByDate.Reverse }}
            {{ $pages = $pages | append ($day.GetPage ($day.Date.Format "/2006/01/02")).Pages.ByDate.Reverse }}
          {{ end }}
        {{ else }}
          {{ range $month := .Pages.ByDate.Reverse }}
            {{ range $day := ($month.GetPage (replaceRE "(\\d{4})/(\\d{2})/" "/$1/$2" $month.File.Dir)).Pages.ByDate.Reverse }}
              {{ $pages = $pages | append ($day.GetPage ($day.Date.Format "/2006/01/02")).Pages.ByDate.Reverse }}
            {{ end }}
          {{ end }}
        {{ end }}
      {{ end }}

      {{ $count := 0 }}
      {{ $displayed := 0 }}
      <main id="echos">
        {{ range $page := $pages }}
          {{ block "echo" . }}
          {{ end }}
  
          {{ if and (ne $count 0) (lt $displayed 2) (eq (mod $count 7) 0) }}
            {{ partial "shared/adsense.html.html" $.Site.Params.adsense.top }}
            {{ $displayed = add $displayed 1 }}
          {{ end }}

          {{ $count = add $count 1 }}
        {{ end }} 
        </main>
      {{ end }}


    {{ partial "shared/adsense.html.html" .Site.Params.adsense.bottom }}
    {{ partial "shared/footer.html.html" . }}
  </body>
</html>
