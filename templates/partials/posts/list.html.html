<!doctype html>
<html lang="ja">
  <head prefix="og: http://ogp.me/ns# website: http://ogp.me/ns/website#">
    {{ partial "shared/meta.html.html" . }}
    {{ partial "posts/meta.html.html" . }}
  </head>
  <body>
    {{ partial "shared/header.html.html" . }}

    {{ define "post-summary" }}
    <article class="summary">
      <p class="date">
        <a href="{{ absURL (.Date.Format "/posts/2006/01/02/") }}">
            <time datetime="{{ .Date.Format "2006-01-02" }}">
              {{ .Date.Format "2006年1月2日" }}
            </time>
        </a>
      </p>
      <a href="{{ .Permalink }}">
        <h1>{{ .Title }}</h1>
        <p>{{ (partial "functions/content.html.html" .Content | unmarshal).summary }}</p>
      </a>
    </article>
    {{ end }}

    {{ if .Page.IsHome }}
      {{ $pager := .Paginate .Site.RegularPages.ByDate.Reverse }}
      {{ $pages := $pager.Pages }}

      {{ $count := 0 }}
      {{ $displayed := 0 }}
      <main id="posts">
        {{ range $idx, $page := $pages }}
          {{ block "post-summary" $page }}
          {{ end }}

          {{ if and (ne $count 0) (lt $displayed 1) (eq (mod $count 7) 0) }}
            {{ partial "shared/adsense.html.html" $.Site.Params.adsense.top }}
            {{ $displayed = add $displayed 1 }}
          {{ end }}

          {{ $count = add $count 1 }}
        {{ end }}
        <nav class="pagination">
          {{ if $pager.HasPrev }}
          <a href="{{ absURL (printf "/posts/pages/%d/" $pager.Prev.PageNumber) }}">前</a>
          {{ end }}

          {{ if $pager.HasNext }}
          <a href="{{ absURL (printf "/posts/pages/%d/"  $pager.Next.PageNumber) }}">次</a>
          {{ end }}
        </nav>
      </main>
    {{ else }}
      {{ $pages := slice }} 

      {{ if eq .Page.Section "tags" }}
        {{ $pages = .Pages.ByDate.Reverse }}
      {{ else }}
        {{ $date := partial "functions/parsedate.html.html" .Page | unmarshal }}

        {{ if (and (default false $date.hasDay) (default false $date.hasMonth)) }}
          {{ $pages = where .Site.RegularPages.ByDate.Reverse "Date.Day" "==" (int $date.day) }}
          {{ $pages = where $pages "Date.Month" "==" (int $date.month) }}
          {{ $pages = where $pages "Date.Year" "==" (int $date.year) }}
        {{ else if (default false $date.hasMonth) }}
          {{ $pages = where .Site.RegularPages.ByDate.Reverse "Date.Month" "==" (int $date.month) }}
          {{ $pages = where $pages "Date.Year" "==" (int $date.year) }}
        {{ else }}
          {{ $pages = where .Site.RegularPages.ByDate.Reverse "Date.Year" "==" (int $date.year) }}
        {{ end }}
      {{ end }}

      {{ $count := 0 }}
      {{ $displayed := 0 }}
      <main id="posts">
        {{ range $idx, $page := $pages }}
          {{ block "post-summary" $page }}
          {{ end }}
          
          {{ if and (ne $count 0) (lt $displayed 2) (eq (mod $count 7) 0) }}
            {{ partial "shared/adsense.html.html" $.Site.Params.adsense.top }}
            {{ $displayed = add $displayed 1 }}
          {{ end }}

          {{ $count = add $count 1 }}
          {{ end }} 
        </main>
      {{ end }}

    {{ partial "shared/adsense.html.html" .Site.Params.adsense.bottom }}

    {{ partial "shared/footer.html.html" . }}
  </body>
</html>
